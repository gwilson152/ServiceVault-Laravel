<template>
  <div class="relative" :id="selectorId">
    <!-- Selected Rate Display -->
    <div 
      v-if="selectedRate || isNoBilling"
      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white flex items-center justify-between cursor-pointer hover:border-blue-500 transition-colors"
      @click="clearSelection"
    >
      <div class="flex items-center space-x-2">
        <div class="flex items-center space-x-1">
          <template v-if="isNoBilling">
            <span class="font-medium text-gray-600 dark:text-gray-400">No Billing</span>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
              Non-billable
            </span>
          </template>
          <template v-else>
            <span class="font-medium">{{ selectedRate.name }}</span>
            <span class="text-gray-500 dark:text-gray-400">- ${{ selectedRate.rate }}/hr</span>
            <span v-if="selectedRate.is_default" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
              Default
            </span>
            <span v-if="selectedRate.inheritance_source === 'account'" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
              Account Rate
            </span>
            <span v-if="selectedRate.inheritance_source === 'parent'" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
              Inherited
            </span>
            <span v-if="selectedRate.inheritance_source === 'global'" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400">
              Global Rate
            </span>
          </template>
        </div>
      </div>
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </div>

    <!-- Search Input (only show when no selection) -->
    <div v-if="!selectedRate && !isNoBilling" class="relative">
      <input
        :id="inputId"
        v-model="searchTerm"
        type="text"
        :placeholder="placeholder"
        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
        @focus="isOpen = true"
        @input="isOpen = true"
        @keydown.escape="closeDropdown"
        @keydown.arrow-down.prevent="navigateDown"
        @keydown.arrow-up.prevent="navigateUp"
        @keydown.enter.prevent="selectHighlighted"
      />
      
      <!-- Loading/Clear Icon -->
      <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
        <div v-if="isLoading" class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500"></div>
        <svg v-else class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- Dropdown List -->
    <div 
      v-if="isOpen && !selectedRate && !isNoBilling"
      :class="[
        'absolute z-[9999] w-full mt-1 bg-white dark:bg-gray-800 shadow-lg border border-gray-200 dark:border-gray-600 rounded-md max-h-60 overflow-auto',
        dropupMode ? 'bottom-full mb-1' : 'top-full mt-1'
      ]"
    >
      <!-- No Billing Option -->
      <div
        :class="[
          'px-3 py-2 cursor-pointer text-sm transition-colors border-b border-gray-200 dark:border-gray-600',
          highlightedIndex === -1 
            ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-900 dark:text-blue-100' 
            : 'text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700'
        ]"
        @click="selectNoBilling"
        @mouseenter="highlightedIndex = -1"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="font-medium text-gray-600 dark:text-gray-400">No Billing</span>
            <span class="text-gray-500 dark:text-gray-400">- Non-billable work</span>
          </div>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
            Non-billable
          </span>
        </div>
      </div>
      
      <div v-if="filteredRates.length === 0" class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">
        {{ isLoading ? 'Loading billing rates...' : 'No billing rates found' }}
      </div>
      
      <template v-else>
        <template v-for="(rate, index) in filteredRates" :key="rate.id">
          <!-- Group Header -->
          <div 
            v-if="shouldShowGroupHeader(rate, index)"
            class="px-3 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600"
          >
            {{ getGroupHeaderLabel(rate.inheritance_source) }}
          </div>
          
          <!-- Rate Item -->
          <div
            :class="[
              'px-3 py-2 cursor-pointer text-sm transition-colors',
              highlightedIndex === index 
                ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-900 dark:text-blue-100' 
                : 'text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700'
            ]"
            @click="selectRate(rate)"
            @mouseenter="highlightedIndex = index"
          >
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="font-medium">{{ rate.name }}</span>
            <span class="text-gray-500 dark:text-gray-400">- ${{ rate.rate }}/hr</span>
          </div>
          <div class="flex items-center space-x-1">
            <span v-if="rate.is_default" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
              Default
            </span>
            <span v-if="rate.inheritance_source === 'account'" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
              Account Rate
            </span>
            <span v-if="rate.inheritance_source === 'parent'" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
              Inherited
            </span>
            <span v-if="rate.inheritance_source === 'global'" class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400">
              Global Rate
            </span>
          </div>
        </div>
            <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
              <div v-if="rate.description">{{ rate.description }}</div>
              <div v-if="rate.inherited_from_account" class="italic">
                Inherited from {{ rate.inherited_from_account }}
              </div>
            </div>
          </div>
        </template>
        
        <!-- Hierarchy Info (optional) -->
        <div v-if="showHierarchyInfo && filteredRates.length > 0" class="px-3 py-2 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
          <div class="text-xs text-gray-500 dark:text-gray-400">
            <p class="font-medium mb-1">Rate Priority:</p>
            <p>Account-specific rates override inherited rates, which override global rates.</p>
          </div>
        </div>
      </template>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'

const props = defineProps({
  modelValue: {
    type: [String, Number],
    default: null
  },
  rates: {
    type: Array,
    default: () => []
  },
  isLoading: {
    type: Boolean,
    default: false
  },
  placeholder: {
    type: String,
    default: 'Select billing rate...'
  },
  showHierarchyInfo: {
    type: Boolean,
    default: false
  },
  reopenOnClear: {
    type: Boolean,
    default: true
  }
})

const emit = defineEmits(['update:modelValue', 'rate-selected'])

// Generate unique IDs for accessibility
const selectorId = `billing-rate-selector-${Math.random().toString(36).substr(2, 9)}`
const inputId = `billing-rate-input-${Math.random().toString(36).substr(2, 9)}`

// Component state
const isOpen = ref(false)
const searchTerm = ref('')
const highlightedIndex = ref(0)
const dropupMode = ref(false)

// Find selected rate
const selectedRate = computed(() => {
  if (!props.modelValue || !props.rates || props.modelValue === 'no-billing') return null
  return props.rates.find(rate => rate.id == props.modelValue) || null
})

// Check if "No Billing" is selected
const isNoBilling = computed(() => {
  return props.modelValue === 'no-billing'
})

// Filter and organize rates based on search and inheritance
const filteredRates = computed(() => {
  if (!props.rates) return []
  
  let rates = props.rates
  
  // Apply search filter if provided
  if (searchTerm.value.trim()) {
    const search = searchTerm.value.toLowerCase()
    rates = rates.filter(rate => 
      rate.name.toLowerCase().includes(search) ||
      rate.rate.toString().includes(search) ||
      (rate.description && rate.description.toLowerCase().includes(search))
    )
  }
  
  // Sort by priority: account-specific rates first, then inherited, then global
  // Within each group, sort defaults first, then by name
  return rates.sort((a, b) => {
    // Priority order: account > parent > global
    const priorityOrder = { account: 0, parent: 1, global: 2 }
    const aPriority = priorityOrder[a.inheritance_source] ?? 3
    const bPriority = priorityOrder[b.inheritance_source] ?? 3
    
    if (aPriority !== bPriority) {
      return aPriority - bPriority
    }
    
    // Within same priority group, defaults first
    if (a.is_default !== b.is_default) {
      return b.is_default - a.is_default
    }
    
    // Then sort by rate amount (higher rates first) for easier selection
    if (a.rate !== b.rate) {
      return b.rate - a.rate
    }
    
    // Finally sort by name
    return a.name.localeCompare(b.name)
  })
})

// Dropdown positioning
const checkDropdownPosition = () => {
  const input = document.getElementById(inputId)
  if (!input) return
  
  const inputRect = input.getBoundingClientRect()
  const viewportHeight = window.innerHeight
  const spaceBelow = viewportHeight - inputRect.bottom
  const spaceAbove = inputRect.top
  
  dropupMode.value = spaceBelow < 250 && spaceAbove > spaceBelow
}

// Group header functions
const shouldShowGroupHeader = (rate, index) => {
  if (index === 0) return true
  const previousRate = filteredRates.value[index - 1]
  return previousRate && previousRate.inheritance_source !== rate.inheritance_source
}

const getGroupHeaderLabel = (inheritanceSource) => {
  switch (inheritanceSource) {
    case 'account':
      return '📋 Account-Specific Rates'
    case 'parent':
      return '🔗 Inherited from Parent Account'
    case 'global':
      return '🌐 Global Default Rates'
    default:
      return 'Other Rates'
  }
}

// Keyboard navigation
const navigateDown = () => {
  if (highlightedIndex.value < filteredRates.value.length - 1) {
    highlightedIndex.value++
  }
}

const navigateUp = () => {
  if (highlightedIndex.value > 0) {
    highlightedIndex.value--
  }
}

const selectHighlighted = () => {
  if (filteredRates.value[highlightedIndex.value]) {
    selectRate(filteredRates.value[highlightedIndex.value])
  }
}

// Rate selection
const selectRate = (rate) => {
  emit('update:modelValue', rate.id)
  emit('rate-selected', rate)
  closeDropdown()
}

const selectNoBilling = () => {
  emit('update:modelValue', 'no-billing')
  emit('rate-selected', null)
  closeDropdown()
}

const clearSelection = () => {
  emit('update:modelValue', null)
  emit('rate-selected', null)
  searchTerm.value = ''
  
  // Optionally reopen dropdown and focus input
  if (props.reopenOnClear) {
    isOpen.value = true
    nextTick(() => {
      const input = document.getElementById(inputId)
      if (input) input.focus()
    })
  }
}

const closeDropdown = () => {
  isOpen.value = false
  searchTerm.value = ''
  highlightedIndex.value = 0
}

// Click outside to close
const handleClickOutside = (event) => {
  const selector = document.getElementById(selectorId)
  if (selector && !selector.contains(event.target)) {
    closeDropdown()
  }
}

// Reset highlighted index when filtered results change
watch(filteredRates, () => {
  highlightedIndex.value = 0
})

// Check dropdown position when opened
watch(isOpen, (newValue) => {
  if (newValue) {
    nextTick(checkDropdownPosition)
  }
})

onMounted(() => {
  document.addEventListener('click', handleClickOutside)
  window.addEventListener('resize', checkDropdownPosition)
})

onUnmounted(() => {
  document.removeEventListener('click', handleClickOutside)
  window.removeEventListener('resize', checkDropdownPosition)
})
</script>